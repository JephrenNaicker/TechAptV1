@page "/results"
@using System.Text.Json
@using TechAptV1.Client.Interface
@using TechAptV1.Client.Models
@using TechAptV1.Client.Services
@inject IDataService DataService
@inject IThreadingService ThreadingService
@inject IJSRuntime JSRuntime
@inject NotificationService Notifications

<h3>Results</h3>
<p>The table shows the top N numbers generated. The download XML and Binary feature allows you to download the entire data set</p>

<div>
	<button class="btn btn-primary" @onclick="(async () => await this.DownloadXml())">Download XML</button>
	<button class="btn btn-primary" @onclick="(async () => await this.DownloadBinary())">Download Binary</button>
</div>
<div>
	<table class="table">
		<thead>
			<tr>
				<th>Value</th>
				<th>IsPrime</th>
			</tr>
		</thead>
		<tbody>
			@if (numbers.Count <= 0)
			{
				<tr>
					<td colspan="2" class="text-center">No Data</td>
				</tr>
			}
			else
			{
				@foreach (var item in numbers)
				{
					<tr>
						<td>@item.Value</td>
						<td>@item.IsPrime</td>
					</tr>
				}
			}
		</tbody>
	</table>
</div>

@code {

	[Inject] public required ILogger<Threading> Logger { get; set; }

	private List<Number> numbers = new ();

	protected override async Task OnInitializedAsync()
	{
		await LoadData();
	}

	private async Task LoadData()
	{
		try
		{
			// Fetch all numbers from the database
			numbers = ( DataService.Get(20)).ToList();   
			Logger.LogInformation("Data loaded successfully.");
		}
		catch (Exception ex)
		{
			Logger.LogError(ex, "Error loading data from the database.");
		}
	}

	/// <summary>
	/// Fetches all the records, serializes them to XML and downloads the file
	/// </summary>
	private async Task DownloadXml()
	{
		try
		{
			this.Logger.LogInformation("DownloadXml");

			var allNumbers = await DataService.GetAll();

			var data = allNumbers.Select(n => new { value = n.Value, isPrime = n.IsPrime }).ToList();
			await JSRuntime.InvokeVoidAsync("downloadXml", data, "numbers.xml");
			await Notifications.ShowSuccessAsync("Download complete!");
		}
		catch (Exception ex)
		{
			await Notifications.ShowErrorAsync($"Download failed: {ex.Message}");
			Logger.LogError(ex, "Xml download  failed");
		}
	}

    /// <summary>
    /// Fetches all the records, serializes them to Binary and downloads the file
    /// </summary>
	private async Task DownloadBinary()
	{
		try
		{
			var binaryData = await ThreadingService.GetBinaryData();

			// Convert to base64 for reliable JS interop
			var base64 = Convert.ToBase64String(binaryData);
			await JSRuntime.InvokeVoidAsync("downloadBinary", base64, "numbers.bin");
			await Notifications.ShowSuccessAsync("Download complete!");
		}
		catch (Exception ex)
		{
			await Notifications.ShowErrorAsync($"Download failed: {ex.Message}");
			Logger.LogError(ex, "Binary download failed");
		}
	}
}
